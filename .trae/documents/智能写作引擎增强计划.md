# 智能写作引擎增强计划

## 📋 计划概述

基于对Arboris-Novel参考项目的分析和当前项目状态，本计划旨在实现智能写作引擎的核心架构升级，采用L1/L2/L3三层架构，全面提升AI写作质量和可控性。

## 🎯 第一阶段目标 (优先级：最高)

从100个目标中选择最核心的15个功能进行实施：

### 一、核心架构层 (1-8)

#### 1. L1规划层实现 - 全知规划层
**目标**：实现项目蓝图和总体大纲生成系统
**功能描述**：
- 创建Blueprint数据模型（世界蓝图）
- 实现项目级蓝图的创建和编辑
- 集成角色、世界观、情节到蓝图
- 提供蓝图可视化和编辑界面

**技术实现**：
- Rust后端：添加blueprints数据库表
- Tauri命令：create_blueprint, get_blueprint, update_blueprint
- 前端：BlueprintEditor组件
- AI集成：基于项目信息生成世界蓝图

#### 2. L2导演层实现 - 章节导演脚本系统
**目标**：为每章生成导演脚本（ChapterMission），控制章节节奏和节拍
**功能描述**：
- 定义ChapterMission数据结构
- 包含macro_beat（宏观节拍）、micro_beats（微观节拍）、pov（视角）、allowed_new_characters等
- AI根据大纲和上下文生成章节导演脚本
- 提供导演脚本的查看和编辑功能

**技术实现**：
- Rust后端：chapter_missions表，相关Tauri命令
- 前端：ChapterMissionPanel组件
- AI提示词：chapter_plan提示词
- 关联到章节编辑流程

#### 3. L3写作层实现 - 有限视角正文生成
**目标**：基于导演脚本生成正文，严格遵循信息可见性原则
**功能描述**：
- 修改现有ai_continue_novel命令
- 接收ChapterMission作为输入
- 严格控制在导演脚本指定的范围内写作
- 支持生成多个版本（2-3个）

**技术实现**：
- 修改commands.rs中的生成逻辑
- 添加ChapterMission参数
- 实现版本差异化生成
- 前端版本选择界面优化

#### 4. 信息可见性过滤系统
**目标**：L3写作层只能看到已登场角色和已公开设定
**功能描述**：
- 追踪已登场角色列表
- 根据章节序号过滤蓝图信息
- 移除未登场角色的详细信息
- 保留允许新登场的角色（由导演脚本指定）

**技术实现**：
- WriterContextBuilder服务（Rust）
- build_visibility_context函数
- 过滤角色、关系、设定信息
- 生成writer_blueprint（裁剪后的蓝图）

#### 5. 跨章1234逻辑
**目标**：通过导演脚本控制每章只写一个节拍
**功能描述**：
- 在ChapterMission中指定当前章节要写的节拍
- 确保每个节拍对应一章
- 支持节拍的分解和合并
- 提供节拍编辑界面

**技术实现**：
- 扩展ChapterMission数据结构
- beat_id关联到大纲的beat
- 前端BeatEditor组件
- 节拍到大纲的双向绑定

#### 6. 后置护栏检查
**目标**：自动检测并修复违规内容
**功能描述**：
- 检测禁止角色是否出现
- 检测信息泄露（未公开设定）
- 检测POV一致性
- 自动尝试修复违规内容

**技术实现**：
- ChapterGuardrails服务（Rust）
- 违规类型定义（ForbiddenCharacter, InfoLeak, POVInconsistency）
- check函数返回违规列表
- rewrite_guardrails提示词修复

#### 7. 章节向量化入库
**目标**：自动将章节内容向量化用于检索
**功能描述**：
- 章节定稿时自动触发向量化
- 使用本地向量数据库（如chroma）
- 存储章节片段和摘要
- 支持向量搜索

**技术实现**：
- VectorStoreService（Rust）
- ingest_chapter函数
- 文本分块策略（段落/句子）
- 向量嵌入API集成

#### 8. 向量检索（RAG）
**目标**：基于向量相似度检索相关历史内容
**功能描述**：
- 根据章节大纲检索相关历史片段
- 检索相关章节摘要
- 智能排序和过滤检索结果
- 将检索结果作为上下文提供给AI

**技术实现**：
- ChapterContextService（Rust）
- retrieve_for_generation函数
- 向量相似度计算
- 检索结果格式化

### 二、高级功能层 (9-15)

#### 9. 自动摘要生成
**目标**：章节自动生成摘要和总结
**功能描述**：
- 章节生成/编辑后自动生成摘要
- 支持不同长度摘要（短/中/长）
- 保存摘要到real_summary字段
- 提供摘要编辑功能

**技术实现**：
- LLMService中的get_summary函数
- temperature=0.15保证准确性
- 异步任务执行
- 前端摘要显示和编辑

#### 10. AI多版本评审
**目标**：AI自动评审多个版本并推荐最佳
**功能描述**：
- 对生成的多个版本进行对比
- 评分维度：一致性、创意性、完整性、节奏
- 推荐最佳版本索引
- 提供评审反馈和建议

**技术实现**：
- AIReviewService（Rust）
- review_versions函数
- evaluation提示词
- 前端版本对比界面

#### 11. 流程编排器
**目标**：PipelineOrchestrator统一编排生成流程
**功能描述**：
- 统一入口：advanced_generate
- 自动执行完整流程：收集上下文→生成导演脚本→过滤信息→生成正文→护栏检查→AI评审
- 支持流程配置（跳过某些步骤）
- 支持异步定稿

**技术实现**：
- PipelineOrchestrator（Rust）
- generate_chapter主函数
- FlowConfig配置
- 前端流程配置界面

#### 12. 定稿服务
**目标**：FinalizeService统一处理定稿逻辑
**功能描述**：
- 选中版本后触发定稿
- 更新章节状态为successful
- 触发摘要生成
- 触发向量化入库
- 写入项目快照（版本控制）

**技术实现**：
- FinalizeService（Rust）
- finalize_chapter函数
- 调用摘要和向量化服务
- 版本控制集成

#### 13. 差异化风格提示
**目标**：不同版本使用不同风格提示词
**功能描述**：
- 版本1：情绪更细腻，节奏更慢，多写内心戏和感官描写
- 版本2：冲突更强，节奏更快，多写动作和对话
- 版本3：悬念更重，多埋伏笔，结尾钩子更强
- 支持自定义风格提示

**技术实现**：
- 在生成提示词中添加version_style_hint
- 版本风格提示词数组
- 用户可自定义
- 前端风格选择界面

#### 14. 章节状态机
**目标**：生成→评审→定稿的完整状态流转
**功能描述**：
- 定义状态：not_generated, generating, waiting_for_review, reviewed, successful, failed
- 状态转换规则和验证
- 状态可视化
- 状态历史记录

**技术实现**：
- ChapterGenerationStatus枚举
- 状态转换函数
- 前端状态显示组件
- 状态操作权限控制

#### 15. 异步任务系统
**目标**：后台异步执行向量化等耗时任务
**功能描述**：
- 异步执行向量化入库
- 异步执行摘要生成
- 任务队列管理
- 任务状态追踪和通知

**技术实现**：
- BackgroundTasks集成（Tauri）
- 任务状态表（task_queue）
- 任务轮询和执行
- 前端任务进度显示

## 📁 文件结构

### 后端新增文件
```
src-tauri/src/
├── services/
│   ├── blueprint_service.rs          # 蓝图管理服务
│   ├── chapter_mission_service.rs     # 导演脚本服务
│   ├── writer_context_builder.rs     # 信息可见性过滤
│   ├── chapter_guardrails.rs         # 护栏检查
│   ├── vector_store_service.rs       # 向量存储服务
│   ├── chapter_context_service.rs     # 章节上下文服务
│   ├── ai_review_service.rs          # AI评审服务
│   ├── pipeline_orchestrator.rs     # 流程编排器
│   └── finalize_service.rs          # 定稿服务
└── models/
    ├── blueprint.rs                  # 蓝图数据模型
    └── chapter_mission.rs           # 导演脚本数据模型
```

### 前端新增文件
```
src/components/
├── BlueprintEditor.tsx              # 蓝图编辑器
├── ChapterMissionPanel.tsx          # 导演脚本面板
├── BeatEditor.tsx                  # 节拍编辑器
├── VersionComparisonPanel.tsx        # 版本对比面板
└── TaskProgressPanel.tsx           # 任务进度面板
```

### 数据库表
```
CREATE TABLE blueprints (
    id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    title TEXT NOT NULL,
    genre TEXT,
    target_length INTEGER,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE chapter_missions (
    id TEXT PRIMARY KEY,
    chapter_id TEXT NOT NULL,
    macro_beat TEXT,
    micro_beats TEXT,
    pov TEXT,
    allowed_new_characters TEXT,
    created_at TEXT NOT NULL,
    FOREIGN KEY (chapter_id) REFERENCES chapters(id) ON DELETE CASCADE
);

CREATE TABLE vector_chunks (
    id TEXT PRIMARY KEY,
    chapter_id TEXT NOT NULL,
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    embedding BLOB,
    metadata TEXT,
    created_at TEXT NOT NULL,
    FOREIGN KEY (chapter_id) REFERENCES chapters(id) ON DELETE CASCADE
);

CREATE TABLE task_queue (
    id TEXT PRIMARY KEY,
    task_type TEXT NOT NULL,
    status TEXT NOT NULL,
    payload TEXT,
    created_at TEXT NOT NULL,
    completed_at TEXT,
    error_message TEXT
);
```

## 🔄 实施顺序

### Week 1: 核心架构 (1-5)
1. L1规划层实现
2. L2导演层实现
3. L3写作层改造
4. 信息可见性过滤系统
5. 跨章1234逻辑

### Week 2: 高级功能 (6-10)
6. 后置护栏检查
7. 章节向量化入库
8. 向量检索（RAG）
9. 自动摘要生成
10. AI多版本评审

### Week 3: 流程和集成 (11-15)
11. 流程编排器
12. 定稿服务
13. 差异化风格提示
14. 章节状态机
15. 异步任务系统

## ✅ 验收标准

### 功能验收
- [ ] 能够创建和编辑项目蓝图
- [ ] 能够生成和查看章节导演脚本
- [ ] 章节生成遵循导演脚本控制
- [ ] 未登场角色不会出现在生成的正文中
- [ ] 违规内容能被检测并修复
- [ ] 章节能被自动向量化
- [ ] 能检索到相关的历史内容
- [ ] 章节能自动生成摘要
- [ ] AI能评审多个版本并推荐最佳
- [ ] 生成流程能被统一编排
- [ ] 定稿后触发完整的后续流程
- [ ] 不同版本有明显的风格差异
- [ ] 章节状态能正确流转
- [ ] 异步任务能正常执行和追踪

### 性能验收
- [ ] 单章节生成时间 < 3分钟
- [ ] 向量化处理时间 < 10秒
- [ ] RAG检索时间 < 1秒
- [ ] UI响应时间 < 500ms

### 质量验收
- [ ] 生成内容质量评分 > 7/10
- [ ] 信息泄露率 < 5%
- [ ] 违规检测准确率 > 90%
- [ ] AI评审推荐准确率 > 80%

## 📝 技术债务

实施过程中需要处理的技术债务：
1. 现有ai_continue_novel命令需要重构以支持新架构
2. 插件系统需要适配新的服务层
3. 云同步需要支持新的数据表
4. 协作功能需要适配新的状态机
5. UI需要大规模调整以适应新流程

## 🚀 后续计划

第一阶段完成后，可以继续实施：
- 多维情感分析系统 (目标16-30)
- 故事轨迹分析系统 (目标31-45)
- 创意指导系统 (目标46-60)
- 高级优化器 (目标61-75)
- 知识库增强 (目标76-85)
- 角色系统增强 (目标86-95)
- 写作工具增强 (目标96-100)
